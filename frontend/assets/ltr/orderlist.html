<!DOCTYPE html>
<html lang="en">

<head>
    <!--=====================================
                    META TAG PART START
        =======================================-->
    <!-- REQUIRE META -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- TEMPLATE META -->
    <meta name="name" content="Greeny">
    <meta name="title" content="Greeny - eCommerce HTML Template">
    <meta name="keywords"
        content="organic, food, shop, ecommerce, store, html, bootstrap, template, agriculture, vegetables, webshop, farm, grocery, natural, online store">
    <!--=====================================
                    META-TAG PART END
        =======================================-->

    <!-- WEBPAGE TITLE -->
    <title>Greeny - Order History</title>

    <!--=====================================
                    CSS LINK PART START
        =======================================-->
    <!-- FAVICON -->
    <link rel="icon" href="images/favicon.png">

    <!-- FONTS -->
    <link rel="stylesheet" href="fonts/flaticon/flaticon.css">
    <link rel="stylesheet" href="fonts/icofont/icofont.min.css">
    <link rel="stylesheet" href="fonts/fontawesome/fontawesome.min.css">

    <!-- VENDOR -->
    <link rel="stylesheet" href="vendor/venobox/venobox.min.css">
    <link rel="stylesheet" href="vendor/slickslider/slick.min.css">
    <link rel="stylesheet" href="vendor/niceselect/nice-select.min.css">
    <link rel="stylesheet" href="vendor/bootstrap/bootstrap.min.css">

    <!-- CUSTOM -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/orderlist.css">
    <!--=====================================
                    CSS LINK PART END
        =======================================-->
</head>

<body>
    <div class="backdrop"></div>
    <a class="backtop fas fa-arrow-up" href="#"></a>


    <!--=====================================
                    HEADER PART START
        =======================================-->
    <div id="header"></div>
    <!-- ✅ Correct ID for header placement -->

    <script type="module">
        import { loadHeader } from "./header.js";

        // ✅ Ensure the element exists before setting innerHTML
        document.getElementById("header").innerHTML = loadHeader();
    </script>
    <!--=====================================
                              HEADER PART END
                  =======================================-->

    <!--=====================================
                            CART SIDEBAR PART START
                  =======================================-->
    <div id="cart-sidebar"></div>
    <!-- ✅ Placeholder for Cart Sidebar -->

    <script type="module">
        import { loadCartSidebar } from "./cart.js";
        let userId = localStorage.getItem("userId");
        console.log(userId);
        // ✅ Ensure the element exists before setting innerHTML
        document.getElementById("cart-sidebar").innerHTML =
            loadCartSidebar(userId);
    </script>

    <!--=====================================
                              CART SIDEBAR PART END
                  =======================================-->

    <!--=====================================
                              NAVBAR PART START
                  =======================================-->
    <div id="nav"></div>
    <script type="module">
        import { loadNavbar } from "./navbar.js";

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("nav").innerHTML = loadNavbar();
        });
    </script>
    <!--=====================================
                              NAVBAR PART END
                  =======================================-->


    <!--=====================================
                    BANNER PART START
        =======================================-->
    <section class="inner-section single-banner" style="background: url(images/single-banner.jpg) no-repeat center;">
        <div class="container">
            <h2>Order History</h2>
        </div>
    </section>
    <!--=====================================
                    BANNER PART END
        =======================================-->


    <!--=====================================
                    ORDERLIST PART START
        =======================================-->
    <section class="inner-section orderlist-part">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="orderlist-filter">
                        <h5>total order <span>- (4)</span></h5>
                        <div class="filter-short">
                            <label class="form-label">short by:</label>
                            <select class="form-select">
                                <option value="all" selected="">all order</option>
                                <option value="recieved">recieved order</option>
                                <option value="processed">processed order</option>
                                <option value="shipped">shipped order</option>
                                <option value="delivered">delivered order</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-12">
                    <div class="orderlist">
                        <div class="orderlist-head">
                            <h5>order#01</h5>
                            <h5>order recieved</h5>
                        </div>
                        <div class="orderlist-body">
                            <div class="row">
                                <!-- order tracking -->
                                <div class="col-lg-12">
                                    <div class="order-track">
                                        <ul class="order-track-list">
                                            <li class="order-track-item active">
                                                <i class="icofont-check"></i>
                                                <span>order recieved</span>
                                            </li>
                                            <li class="order-track-item ">
                                                <i class="icofont-check"></i>
                                                <span>order processed</span>
                                            </li>
                                            <li class="order-track-item">
                                                <i class="icofont-close"></i>
                                                <span>order shipped</span>
                                            </li>
                                            <li class="order-track-item">
                                                <i class="icofont-close"></i>
                                                <span>order delivered</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="col-lg-5">
                                    <ul class="orderlist-details">
                                        <li>
                                            <h6>Order ID</h6>
                                            <p id="orderId">Loading...</p>
                                        </li>
                                        <li>
                                            <h6>Total Items</h6>
                                            <p id="totalItems">Loading...</p>
                                        </li>
                                        <li>
                                            <h6>Order Time</h6>
                                            <p id="orderTime">Loading...</p>
                                        </li>
                                        <li>
                                            <h6>Delivery Time</h6>
                                            <p id="deliveryTime">Loading...</p>
                                        </li>
                                    </ul>
                                </div>

                                <div class="col-lg-3">
                                    <div class="orderlist-deliver">
                                        <h6>Delivery Location</h6>
                                        <p id="deliveryLocation">loading...</p>
                                    </div>
                                </div>

                                <div class="col-lg-12">
                                    <div class="table-scroll">
                                        <table class="table-list">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Serial</th>
                                                    <th scope="col">Product</th>
                                                    <th scope="col">Name</th>
                                                    <th scope="col">Price</th>
                                                    <th scope="col">Quantity</th>
                                                </tr>
                                            </thead>
                                            <tbody id="productTableBody">
                                                <!-- Dynamic product rows will be inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <script>
                                    // Function to fetch and display order details
                                    async function fetchOrderDetails() {
                                        try {
                                            // Get userId from localStorage
                                            const userId = localStorage.getItem('userId');

                                            if (!userId) {
                                                console.warn('No userId found in localStorage');
                                                return;
                                            }

                                            // Fetch orders by userId
                                            const response = await fetch(`http://localhost:5000/api/orders/user/${userId}`);

                                            if (!response.ok) {
                                                throw new Error(`HTTP error! status: ${response.status}`);
                                            }

                                            const orders = await response.json();

                                            if (orders.length === 0) {
                                                console.warn('No orders found for this user');
                                                document.getElementById('orderId').innerText = 'No Orders';
                                                return;
                                            }

                                            // Display the first order's details
                                            let order = orders[0];
                                            document.getElementById('orderId').innerText = order.orderNumber || 'N/A';
                                            document.getElementById('totalItems').innerText = `${order.products.length || 0} Items`;

                                            const orderDate = new Date(order.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                                            document.getElementById('orderTime').innerText = orderDate;

                                            // Assuming delivery is 5 days after order date
                                            const deliveryDate = new Date(order.createdAt);
                                            const schedule = order.deliverySchedule?.toLowerCase(); // To handle case-insensitivity

                                            if (schedule === 'express' || schedule === '8am-10pm') {
                                                // Same-day delivery
                                                document.getElementById('deliveryTime').innerText = deliveryDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                                            } else {
                                                // Next-day delivery
                                                deliveryDate.setDate(deliveryDate.getDate() + 1);
                                                document.getElementById('deliveryTime').innerText = deliveryDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
                                            }

                                            document.getElementById('deliveryLocation').innerText = order.deliveryAddresses[0]?.address || 'No location provided';


                                            // Assuming first order for demo
                                            order = orders[0]; // Assuming first order
                                            const productTableBody = document.getElementById('productTableBody');
                                            productTableBody.innerHTML = ''; // Clear existing table data

                                            // Loop through products in order and fetch details
                                            for (const [index, orderProduct] of order.products.entries()) {
                                                try {
                                                    const productId = orderProduct.product; // Product ID from orders

                                                    // Fetch product details using productId
                                                    const productResponse = await fetch(`http://localhost:5000/api/products/${productId}`);
                                                    if (!productResponse.ok) {
                                                        console.error(`Failed to fetch product with ID: ${productId}`);
                                                        continue;
                                                    }

                                                    const productDetails = await productResponse.json();
                                                    console.log("Product Details:", productDetails); // ✅ Verify image path here

                                                    // ✅ Prepend backend URL to image path
                                                    const imageUrl = `http://localhost:5000${productDetails.image}`
                                                         
                                                       console.log(productDetails.image);
                                                       
                                                    // Create table row with product details
                                                    const row = `
            <tr>
                <td class="table-serial"><h6>${index + 1}</h6></td>
                <td class="table-image"><img src=${imageUrl} alt="${productDetails.name}" width="60"></td>
                <td class="table-name"><h6>${productDetails.name}</h6></td>
                <td class="table-price"><h6>₹${productDetails.price}<small>/kilo</small></h6></td>
                <td class="table-quantity"><h6>${orderProduct.quantity}</h6></td>
            </tr>
        `;
                                                    productTableBody.insertAdjacentHTML('beforeend', row);
                                                } catch (error) {
                                                    console.error(`Error fetching product ${orderProduct.product}:`, error);
                                                }
                                            }


                                        } catch (error) {
                                            console.error('Error fetching order:', error);
                                            document.getElementById('orderId').innerText = 'Error loading order';
                                        }
                                    }

                                    // Call the function on page load
                                    fetchOrderDetails();
                                </script>





                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>



    <!--=====================================
                    ORDERLIST PART END
        =======================================-->

    <!--=====================================
                    INTRO PART START
        =======================================-->
    <div id="section"></div>

    <!-- Import the ES6 Module -->
    <script type="module">
        import createIntroSection from './intro.js';
        document.getElementById('section').innerHTML = createIntroSection();
    </script>
    <!--=====================================
                    INTRO PART END
        =======================================-->


    <!--=====================================
                     FOOTER PART START
        =======================================-->
    <div id="footer"></div>

    <script type="module">
        import { loadFooter } from './footer.js';
        document.getElementById('footer').innerHTML = loadFooter();
    </script>
    <!--=====================================
                      FOOTER PART END
        =======================================-->


    <!--=====================================
                    JS LINK PART START
        =======================================-->
    <!-- VENDOR -->
    <script src="vendor/bootstrap/jquery-1.12.4.min.js"></script>
    <script src="vendor/bootstrap/popper.min.js"></script>
    <script src="vendor/bootstrap/bootstrap.min.js"></script>
    <script src="vendor/countdown/countdown.min.js"></script>
    <script src="vendor/niceselect/nice-select.min.js"></script>
    <script src="vendor/slickslider/slick.min.js"></script>
    <script src="vendor/venobox/venobox.min.js"></script>

    <!-- CUSTOM -->
    <script src="js/nice-select.js"></script>
    <script src="js/countdown.js"></script>
    <script src="js/accordion.js"></script>
    <script src="js/venobox.js"></script>
    <script src="js/slick.js"></script>
    <script src="js/main.js"></script>
    <!--=====================================
                    JS LINK PART END
        =======================================-->
</body>

</html>